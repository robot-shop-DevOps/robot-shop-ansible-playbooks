---
- name: Install OpenResty on Ubuntu 22+
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    install_recommended: true
  
  tasks:
    - name: Install prerequisites using shell
      shell: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        apt-get install -y --no-install-recommends wget gnupg ca-certificates lsb-release
      args:
        executable: /bin/bash
      register: prereq_result
      changed_when: "'0 newly installed' not in prereq_result.stdout"

    - name: Download OpenResty GPG key
      get_url:
        url: https://openresty.org/package/pubkey.gpg
        dest: /tmp/openresty-pubkey.gpg
        mode: '0644'

    - name: Create keyrings directory
      file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: Import OpenResty GPG key
      shell: |
        gpg --dearmor < /tmp/openresty-pubkey.gpg > /usr/share/keyrings/openresty.gpg
      args:
        creates: /usr/share/keyrings/openresty.gpg
        executable: /bin/bash

    - name: Add OpenResty repository
      copy:
        content: "deb [signed-by=/usr/share/keyrings/openresty.gpg] http://openresty.org/package/ubuntu {{ ansible_distribution_release }} main\n"
        dest: /etc/apt/sources.list.d/openresty.list
        mode: '0644'

    - name: Update apt cache after adding repository
      shell: |
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        apt-get update
      args:
        executable: /bin/bash
      register: apt_update_result
      changed_when: true

    - name: Verify openresty package is available
      shell: apt-cache policy openresty
      register: openresty_check
      changed_when: false
      failed_when: false

    - name: Show openresty availability
      debug:
        var: openresty_check.stdout_lines

    - name: Install OpenResty using apt-get (with recommended packages)
      shell: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y openresty
      args:
        executable: /bin/bash
      when: install_recommended
      register: install_result

    - name: Install OpenResty using apt-get (without recommended packages)
      shell: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y --no-install-recommends openresty
      args:
        executable: /bin/bash
      when: not install_recommended
      register: install_result

    - name: Verify OpenResty installation
      shell: openresty -v
      register: version_check
      changed_when: false

    - name: Display OpenResty version
      debug:
        msg: "{{ version_check.stderr }}"

    - name: Clean up temporary files
      file:
        path: /tmp/openresty-pubkey.gpg
        state: absent